*2018-02-28*

# Bihu Smart Contract Formal Verification

We present a formal verification of Bihu KEY token operation contracts, upon request from the [Bihu] team represented by Dr. Bin Lu (Gulu) and Mr. Huafu Bao.

Bihu is a blockchain-based ID system, and [KEY] is the utility token for the Bihu ID system and community.

The smart contracts requested to be formally verified are the ones for operating the KEY tokens.
The [Solidity source code][src] of those contracts and their [informal specification] are publicly available.

This directory contains the artifact of the Bihu contracts formal verification, as a companion to the formal verification report:

<img src="../scripts/pdf-icon.png" alt="PDF" width="2%" /> *[Bihu Smart Contract Formal Verification]*

## Formal Verification Methodology

Our methodology for formal verification of smart contracts is as follows.  First, we formalize the high-level business logic of the smart contracts, based on a typically informal specification provided by the client, to provide us with a precise and comprehensive specification of the functional correctness properties of the smart contracts.  This high-level specification needs to be confirmed by the client, possibly after several rounds of discussions and changes, to ensure that it correctly captures the intended behavior of their contract.  Then we refine the specification all the way down to the Ethereum Virtual Machine (EVM) level, often in multiple steps, to capture the EVM-specific details.  The role of the final EVM-level specification is to ensure that nothing unexpected happens at the bytecode level, that is, that only what was specified in the high-level specification will happen when the bytecode is executed.  To precisely reason about the EVM bytecode without missing any EVM quirks, we adopted [KEVM], a complete formal semantics of the EVM, and instantiated the [K-framework]'s [reachability logic theorem prover] to generate a correct-by-construction deductive program verifier for the EVM.  We use the verifier to verify the compiled EVM bytecode of the smart contract against its EVM-level specification.  Note that the Solidity compiler is not part of our trust base, since we directly verify the compiled EVM bytecode.  Therefore, our verification result does not depend on the correctness of the Solidity compiler.

## Target Smart Contracts

The target contracts of our formal verification are the following, where we took the Solidity source code from Bihu's Github repository, https://github.com/bihu-id/bihu-contracts, commit [f9a7ab65](https://github.com/bihu-id/bihu-contracts/tree/f9a7ab65181cc204332e17df30406612d5d350ef/src):

* [KeyRewardPool.sol](https://github.com/bihu-id/bihu-contracts/blob/f9a7ab65181cc204332e17df30406612d5d350ef/src/KeyRewardPool.sol)
* [WarmWallet.sol](https://github.com/bihu-id/bihu-contracts/blob/f9a7ab65181cc204332e17df30406612d5d350ef/src/WarmWallet.sol)

More specifically, we formally verified the functional correctness of the following two functions:

* [KeyRewardPool.collectToken()](https://github.com/bihu-id/bihu-contracts/blob/f9a7ab65181cc204332e17df30406612d5d350ef/src/KeyRewardPool.sol#L50-L85)
* [WarmWallet.forwardToHotWallet()](https://github.com/bihu-id/bihu-contracts/blob/f9a7ab65181cc204332e17df30406612d5d350ef/src/WarmWallet.sol#L69-L81)

## Verification Artifacts

### Solidity Source Code and Compiled EVM Bytecode

We verified mathematically equivalent variants of each target function.
Due to time constraints (we started working on this verification project on 2018-02-13), we have *not* verified the external call to `key.balanceOf` and `key.transfer`.
We took the modified source code, inlined the DSMath contract and the DSToken contract interface, and compiled it to the EVM bytecode using Remix Solidity IDE (of the version `soljson-v0.4.20+commit.3155dd80`).

The modified and inlined source code of (the contracts of) each target function:

* [collectToken/KeyRewardPool.modified.inlined.sol](collectToken/KeyRewardPool.modified.inlined.sol)
* [forwardToHotWallet/WarmWallet.modified.inlined.sol](forwardToHotWallet/WarmWallet.modified.inlined.sol)

The EVM (runtime) bytecode generated by the Remix Solidity compiler:

* [collectToken/KeyRewardPool.modified.inlined.bytes](collectToken/KeyRewardPool.modified.inlined.bytes)
* [forwardToHotWallet/WarmWallet.modified.inlined.bytes](forwardToHotWallet/WarmWallet.modified.inlined.bytes)

The Remix IDE-generated Gist links:

* collectToken/KeyRewardPool.modified.inlined.gist: https://gist.github.com/anonymous/61b969d0f7af252a54f48f4b50f2c3f5
* forwardToHotWallet/WarmWallet.modified.inlined.gist: https://gist.github.com/anonymous/b7773008aa9dc75815f1c6ecfb7224a0

The (annotated) EVM assemblies disassembled from each bytecode:

* [collectToken/KeyRewardPool.modified.inlined.evm](collectToken/KeyRewardPool.modified.inlined.evm)
* [forwardToHotWallet/WarmWallet.modified.inlined.evm](forwardToHotWallet/WarmWallet.modified.inlined.evm)

The original, inlined source code of (the contracts of) each target function:

* [collectToken/KeyRewardPool.inlined.sol](collectToken/KeyRewardPool.inlined.sol) &nbsp; [[Gist link]](https://gist.github.com/anonymous/08052033a247f241c9519e41d6fcd27d)
* [forwardToHotWallet/WarmWallet.inlined.sol](forwardToHotWallet/WarmWallet.inlined.sol) &nbsp; [[Gist link](https://gist.github.com/anonymous/c95f67810dff2af73b240c78aab4e3b9)]

### Mechanized Specifications and Proofs

Following our formal verification methodology described above, we formalized the high-level specification of the smart contracts based on the [informal specification], and the Bihu team has confirmed that the specification correctly captured the intended behavior of their contract.
Then, we refined the specification all the way down to the Ethereum Virtual Machine (EVM) level to capture the EVM-specific details.
The EVM-level specification is fully mechanized within and automatically verified by our EVM verifier, a correct-by-construction deductive program verifier derived from [KEVM] and [K-framework]'s [reachability logic theorem prover].

The following are the mechanized EVM-level specifications of each target function:

* EVM specification of `collectToken`: [collectToken-spec.ini]
* EVM specification of `forwardToHotWallet`: [forwardToHotWallet-spec.ini]

The specifications are written in [eDSL], a domain-specific language for EVM specifications, whose good understanding is required in order to understand any of our EVM-level specifications well.  Refer to [resources] for background on our technology.  The above files provide the [eDSL] specification template parameters, the full K reachability logic specifications being automatically derived from a specification template by instantiating it with the template parameters.  The following commands generate the full specifications:

```
$ ../scripts/gen-spec.py spec-tmpl.k collectToken-spec.ini       > collectToken-spec.k
$ ../scripts/gen-spec.py spec-tmpl.k forwardToHotWallet-spec.ini > forwardToHotWallet-spec.k
```

#### Reproducing Proofs

To prove that each specification is satisfied by (the compiled EVM bytecode of) each target function, run the EVM verifier as follows:

```
$ kevm prove collectTokens-spec.k
$ kevm prove forwardToHotWallet-spec.k
```

The above commands essentially execute the following commands:

```
$ kprove collectTokens-spec.k      -m VERIFICATION --z3-executable -d /path/to/evm-semantics/.build/java
$ kprove forwardToHotWallet-spec.k -m VERIFICATION --z3-executable -d /path/to/evm-semantics/.build/java
```

#### Installing the EVM Verifier

The EVM verifier is part of the KEVM project.  The following commands will successfully install it, provided that all of the dependencies are installed.

```
$ git clone git@github.com:kframework/evm-semantics.git
$ cd evm-semantics
$ make deps
$ make
```

For detailed instructions on installing and running the EVM verifier, see [KEVM]'s [Installing/Building](https://github.com/kframework/evm-semantics/blob/master/README.md#installingbuilding) and [Example Usage](https://github.com/kframework/evm-semantics/blob/master/README.md#example-usage) pages.


## [Resources](../README.md#resources)

## [Disclaimer](../README.md#disclaimer)


[Bihu]: <https://bihu.com/>
[KEY]: <https://etherscan.io/address/0x4cd988afbad37289baaf53c13e98e2bd46aaea8c#code>
[formal verification methodology]: <methodology.md>
[KEVM]: <https://github.com/kframework/evm-semantics>
[K-framework]: <http://www.kframework.org>
[reachability logic theorem prover]: <http://fsl.cs.illinois.edu/index.php/Semantics-Based_Program_Verifiers_for_All_Languages>
[collectToken-spec.ini]: <collectToken-spec.ini>
[forwardToHotWallet-spec.ini]: <forwardToHotWallet-spec.ini>
[informal specification]: <https://docs.google.com/document/d/1-PilHhInQxGod7FZNbtfv2bbgV1045ROT5TO3WLhDOE>
[src]: <https://github.com/bihu-id/bihu-contracts/tree/f9a7ab65181cc204332e17df30406612d5d350ef/src>
[formal verification report]: <bihu-contracts-verification-report.pdf>
[Bihu Smart Contract Formal Verification]: <bihu-contracts-verification-report.pdf>
[resources]: <../README.md#resources>
[eDSL]: <../resources/edsl.md>
